<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chatbot Unla - Base de Conocimiento</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<link href="/css/style-custom.css" rel="stylesheet" />

<style>
    .card-preview { margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .preview-input.is-invalid { border-color: #dc3545 !important; background-color: #ffe5e5 !important; }
    .delete-btn { cursor: pointer; }
    .char-counter { font-size:12px; color:#666; }
    .char-counter.exceeded { color:red; font-weight:bold; }
</style>
</head>

<body>
<div class="wrapper">
    <div th:replace="fragments/sidebar :: sidebar" id="sidebar"></div>

    <div class="content" id="content">
        <div class="container py-4">

            <h2 class="mb-4 text-center" th:text="${titulo}">Formulario Base de Conocimiento</h2>

            <div th:if="${error != null}" class="alert alert-danger" th:text="${error}"></div>
            <div th:if="${success != null}" class="alert alert-success" th:text="${success}"></div>

            <!-- Subir Archivo -->
				<div class="card mb-4"
					th:if="${preview == null or preview.isEmpty()}">
					<div class="card-body">
						<h5 class="card-title">Cargar Archivo CSV / Excel</h5>

						<form th:action="@{/baseDeConocimiento/uploadPreview}"
							method="post" enctype="multipart/form-data">

							<div class="mb-3">
								<input type="file" name="file" class="form-control"
									accept=".csv,.xlsx" />
							</div>

							<!-- Acciones -->
							<div
								class="d-flex justify-content-between align-items-center mt-3">

								<!-- Izquierda: volver -->
								<a class="btn btn-outline-secondary btn-sm"
									th:href="@{/baseDeConocimiento/lista}"> <i
									class="bi bi-arrow-left"></i> Volver
								</a>

								<!-- Derecha: acciones principales -->
								<div class="d-flex gap-2">
									<a href="/baseDeConocimiento/descargar-ejemplo"
										class="btn btn-outline-secondary btn-sm"> <i
										class="bi bi-download"></i> Descargar ejemplo
									</a>

									<button type="submit" class="btn btn-primary btn-sm">
										<i class="bi bi-upload"></i> Cargar archivo
									</button>
								</div>

							</div>
						</form>
					</div>
				</div>
				<!-- Preview de archivo -->
            <div id="previewContainer" th:if="${preview != null and !preview.isEmpty()}">

                <form id="previewForm" th:action="@{/baseDeConocimiento/saveFromPreview}" method="post">
                    <div id="previewBody">

                        <div th:each="item, iterStat : ${preview}"
                             class="card card-preview p-3">
                             
                             <div class="d-flex align-items-center">

	                            <div class="flex-grow-1 me-2">
	
	                                <!-- PREGUNTA -->
	                                <input type="text"
	                                       th:name="${'pregunta_' + iterStat.index}"
	                                       th:value="${item.pregunta}"
	                                       class="form-control preview-input mb-1"
	                                       maxlength="500"
	                                       title="Límite de 500 caracteres"
	                                       th:classappend="${duplicadas != null and #lists.contains(duplicadas, item.pregunta)} ? 'is-invalid' : ''"
	                                       th:attr="data-original=${item.pregunta},
	                                                data-duplicado-inicial=${duplicadas != null and #lists.contains(duplicadas, item.pregunta)}" />
	
	                                <div class="char-counter pregunta-counter"></div>
	
	                                <!-- RESPUESTA -->
										<input type="text" th:name="${'respuesta_' + iterStat.index}"
											th:value="${item.respuesta}"
											class="form-control preview-input mt-2 respuesta-editable"
											maxlength="1500" title="Límite de 1500 caracteres" />

										<div class="char-counter respuesta-counter"></div>
	                                
	                                
	                            </div>
	                            
	                            <button type="button" class="btn btn-danger btn-sm delete-btn ms-2">Eliminar</button>
	                        </div>
                            <!-- ================= CONFLICTO EMBEBIDO ================= -->
							<div th:if="${conflictos != null}">

									<div th:each="conf : ${conflictos}"
										th:if="${conf.pregunta == item.pregunta}"
										class="mt-3 border-top pt-3 conflicto-block">

										<p class="text-warning fw-bold mb-2">Pregunta existente
											deshabilitada</p>

										<div class="row">
											<div class="col-md-6">
												<label class="form-label">Respuesta actual</label>
												<textarea class="form-control" rows="3" disabled
													th:text="${conf.respuestaExistente}"></textarea>
											</div>

											<div class="col-md-6">
												<label class="form-label">Nueva respuesta</label>
												<textarea class="form-control respuesta-preview" rows="3"
													disabled></textarea>

												<input type="hidden" name="conflicto_respuesta"
													class="conflicto-hidden-respuesta" />
											</div>
										</div>

										<div class="form-check mt-2 d-flex align-items-center gap-2">
											<input class="form-check-input" type="checkbox"
												name="confirmar_conflicto" th:value="${conf.pregunta}">

											<span class="form-check-label"> Actualizar y habilitar
												esta pregunta </span> <input type="hidden"
												name="conflicto_respuesta" th:value="${conf.respuestaNueva}" />
										</div>
									</div>


								</div>

                    </div>

                                      <input type="hidden" name="total" id="totalPreview"
                           th:value="${preview.size()}" />

					<div class="d-flex justify-content-between align-items-center mt-3">

								<!-- Izquierda: volver -->
								<a class="btn btn-outline-secondary btn-sm"
									th:href="@{/baseDeConocimiento/upload}"> <i
									class="bi bi-arrow-left"></i> Volver
								</a>
                    <button type="submit" class="btn btn-success mt-3" id="saveAllBtn"
                            th:disabled="${duplicadas != null and !#lists.isEmpty(duplicadas)}">
                        Guardar todas
                    </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const previewBody = document.getElementById('previewBody');
const totalInput = document.getElementById('totalPreview');
const saveBtn = document.getElementById('saveAllBtn');

/* ---------------- ELIMINAR FILA ---------------- */
previewBody?.addEventListener('click', e => {
    if (e.target.classList.contains('delete-btn')) {
        if (confirm('¿Está seguro que desea eliminar esta pregunta?')) {
            e.target.closest('.card-preview').remove();
            reindexInputs();
            updateTotal();
            validarTodo();
        }
    }
});

/* ---------------- ESCUCHAR CAMBIOS ---------------- */
previewBody?.addEventListener('input', e => {

    if (e.target.classList.contains('preview-input')) {
        validarTodo();
    }

    /* --------- RESPUESTA EN TIEMPO REAL --------- */
    if (e.target.classList.contains('respuesta-editable')) {
        const card = e.target.closest('.card-preview');
        if (!card) return;

        const value = e.target.value;

        const textareaPreview = card.querySelector('.respuesta-preview');
        const hidden = card.querySelector('.conflicto-hidden-respuesta');

        if (textareaPreview) textareaPreview.value = value;
        if (hidden) hidden.value = value;
    }

    /* --------- PREGUNTA → MOSTRAR / OCULTAR CONFLICTO --------- */
    if (e.target.name?.startsWith('pregunta_')) {
        manejarConflictoPregunta(e.target);
    }
});

/* ---------------- CONFLICTO DINÁMICO ---------------- */
function manejarConflictoPregunta(preguntaInput) {
    const card = preguntaInput.closest('.card-preview');
    if (!card) return;

    const original = (preguntaInput.dataset.original || '').trim();
    const actual = preguntaInput.value.trim();

    const conflictoBlock = card.querySelector('.conflicto-block');
    if (!conflictoBlock) return;

    if (actual === original) {
        conflictoBlock.style.display = '';
    } else {
        conflictoBlock.style.display = 'none';

        // limpiar estado al ocultar
        const checkbox = conflictoBlock.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
    }
}

/* ---------------- VALIDACIÓN COMPLETA ---------------- */
function validarTodo() {
    const cards = Array.from(previewBody.querySelectorAll('.card-preview'));
    let hayInvalidos = false;

    cards.forEach(card => {
        const preguntaInput = card.querySelector('input[name^="pregunta_"]');
        const respuestaInput = card.querySelector('input[name^="respuesta_"]');

        const pregunta = preguntaInput.value.trim();
        const respuesta = respuestaInput.value.trim();

        const original = (preguntaInput.dataset.original || '').trim();
        const duplicadoInicial = preguntaInput.dataset.duplicadoInicial === "true";

        const todas = cards.map(c =>
            c.querySelector('input[name^="pregunta_"]').value.trim()
        );

        let esDuplicado = false;
        if (pregunta === original) {
            esDuplicado = duplicadoInicial;
        } else {
            esDuplicado = todas.filter(v => v === pregunta).length > 1;
        }

        const invalidaPregunta = esDuplicado || pregunta.length > 500;
        const invalidaRespuesta = respuesta.length > 1500;

        preguntaInput.classList.toggle("is-invalid", invalidaPregunta);
        respuestaInput.classList.toggle("is-invalid", invalidaRespuesta);

        if (invalidaPregunta || invalidaRespuesta) {
            hayInvalidos = true;
        }
    });

    saveBtn.disabled = hayInvalidos || cards.length === 0;
    actualizarContadores();
}

/* ---------------- CONTADORES ---------------- */
function actualizarContadores() {
    previewBody.querySelectorAll('.card-preview').forEach(card => {
        const pregunta = card.querySelector('input[name^="pregunta_"]');
        const respuesta = card.querySelector('input[name^="respuesta_"]');

        card.querySelector('.pregunta-counter').textContent =
            `${pregunta.value.length} / 500`;
        card.querySelector('.respuesta-counter').textContent =
            `${respuesta.value.length} / 1500`;
    });
}

/* ---------------- REINDEX ---------------- */
function reindexInputs() {
    previewBody.querySelectorAll('.card-preview').forEach((card, i) => {
        card.querySelector('input[name^="pregunta_"]').name = `pregunta_${i}`;
        card.querySelector('input[name^="respuesta_"]').name = `respuesta_${i}`;
    });
    updateTotal();
}

function updateTotal() {
    totalInput.value = previewBody.children.length;
}

/* ---------------- INIT ---------------- */
document.querySelectorAll('input[name^="pregunta_"]').forEach(manejarConflictoPregunta);
validarTodo();

document.querySelectorAll('.card-preview').forEach(card => {
    const respuestaInput = card.querySelector('.respuesta-editable');
    const textareaPreview = card.querySelector('.respuesta-preview');
    const hidden = card.querySelector('.conflicto-hidden-respuesta');

    if (!respuestaInput) return;

    const valorInicial = respuestaInput.value;

    if (textareaPreview && textareaPreview.value === '') {
        textareaPreview.value = valorInicial;
    }

    if (hidden && hidden.value === '') {
        hidden.value = valorInicial;
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
