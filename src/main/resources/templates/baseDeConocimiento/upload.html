<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chatbot Unla - Base de Conocimiento</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
<link href="/css/style-custom.css" rel="stylesheet" />

<style>
    .card-preview { margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .preview-input.is-invalid { border-color: #dc3545 !important; background-color: #ffe5e5 !important; }
    .delete-btn { cursor: pointer; }
    .char-counter { font-size:12px; color:#666; }
    .char-counter.exceeded { color:red; font-weight:bold; }
</style>
</head>

<body>
<div class="wrapper">
    <div th:replace="fragments/sidebar :: sidebar" id="sidebar"></div>

    <div class="content" id="content">
        <div class="container py-4">

            <h2 class="mb-4 text-center" th:text="${titulo}">Formulario Base de Conocimiento</h2>

            <div th:if="${error != null}" class="alert alert-danger" th:text="${error}"></div>
            <div th:if="${success != null}" class="alert alert-success" th:text="${success}"></div>

            <!-- Subir Archivo -->
				<div class="card mb-4"
					th:if="${preview == null or preview.isEmpty()}">
					<div class="card-body">
						<h5 class="card-title">Cargar Archivo CSV / Excel</h5>

						<form th:action="@{/baseDeConocimiento/uploadPreview}"
							method="post" enctype="multipart/form-data">

							<div class="mb-3">
								<input type="file" name="file" class="form-control"
									accept=".csv,.xlsx" />
							</div>

							<!-- Acciones -->
							<div
								class="d-flex justify-content-between align-items-center mt-3">

								<!-- Izquierda: volver -->
								<a class="btn btn-outline-secondary btn-sm"
									th:href="@{/baseDeConocimiento/lista}"> <i
									class="bi bi-arrow-left"></i> Volver
								</a>

								<!-- Derecha: acciones principales -->
								<div class="d-flex gap-2">
									<a href="/baseDeConocimiento/descargar-ejemplo"
										class="btn btn-outline-secondary btn-sm"> <i
										class="bi bi-download"></i> Descargar ejemplo
									</a>

									<button type="submit" class="btn btn-primary btn-sm">
										<i class="bi bi-upload"></i> Cargar archivo
									</button>
								</div>

							</div>
						</form>
					</div>
				</div>
				<!-- Preview de archivo -->
            <div id="previewContainer" th:if="${preview != null and !preview.isEmpty()}">

                <form id="previewForm" th:action="@{/baseDeConocimiento/saveFromPreview}" method="post">
						<div id="previewBody">

							<div th:each="item, iterStat : ${preview}"
     class="card card-preview mb-2">

    <!-- HEADER -->
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <small class="fw-semibold text-secondary">
            <i class="bi bi-chat-left-text me-1"></i>
            Entrada #[[${iterStat.index + 1}]]
        </small>

        <button type="button"
                class="btn btn-outline-danger btn-sm delete-btn"
                title="Eliminar">
            <i class="bi bi-trash"></i>
        </button>
    </div>

    <!-- BODY -->
    <div class="card-body">

        <!-- PREGUNTA -->
        <div class="mb-1">
            <label class="form-label fw-semibold small">
                Pregunta
            </label>

            <input type="text"
                   th:name="${'pregunta_' + iterStat.index}"
                   th:value="${item.pregunta}"
                   class="form-control form-control-sm preview-input"
                   maxlength="500"
                   th:classappend="${duplicadas != null and #lists.contains(duplicadas, item.pregunta)} ? 'is-invalid' : ''"
                   th:attr="data-original=${item.pregunta},
                            data-duplicado-inicial=${duplicadas != null and #lists.contains(duplicadas, item.pregunta)}" />

            <div class="char-counter pregunta-counter text-end"></div>
        </div>

        <!-- RESPUESTA -->
        <div class="mb-1">
            <label class="form-label fw-semibold small">
                Respuesta
            </label>

            <input type="text"
                   th:name="${'respuesta_' + iterStat.index}"
                   th:value="${item.respuesta}"
                   class="form-control form-control-sm preview-input respuesta-editable"
                   maxlength="1500" />

            <div class="char-counter respuesta-counter text-end"></div>
        </div>

        <!-- CONFLICTO -->
        <div th:if="${conflictos != null}">
            <div th:each="conf : ${conflictos}"
                 th:if="${conf.pregunta == item.pregunta}"
                 class="alert alert-warning mt-2 conflicto-block">

                <div class="d-flex align-items-center mb-1">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    <small class="fw-semibold">
                        Pregunta existente deshabilitada
                    </small>
                </div>

                <div class="row g-1">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">
                            Respuesta en la base de conocimiento
                        </label>
                        <textarea class="form-control form-control-sm"
                                  rows="2"
                                  disabled
                                  th:text="${conf.respuestaExistente}"></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label small text-muted">
                            Nueva respuesta
                        </label>
                        <textarea class="form-control form-control-sm respuesta-preview"
                                  rows="2"
                                  disabled></textarea>

                        <input type="hidden"
                               name="conflicto_respuesta"
                               class="conflicto-hidden-respuesta" />
                    </div>
                </div>

                <div class="form-check mt-1">
                    <input class="form-check-input"
                           type="checkbox"
                           name="confirmar_conflicto"
                           th:value="${conf.pregunta}"
                           id="conflictCheck__[[${iterStat.index}]]">

                    <label class="form-check-label small fw-semibold"
                           th:for="'conflictCheck__' + ${iterStat.index}">
                        Actualizar y habilitar esta pregunta
                    </label>

                    <input type="hidden"
                           name="conflicto_respuesta"
                           th:value="${conf.respuestaNueva}" />
                </div>
            </div>
        </div>

    </div>
</div>
						</div>

						<input type="hidden" name="total" id="totalPreview"
                           th:value="${preview.size()}" />

					<div class="d-flex justify-content-between align-items-center mt-3">

								<!-- Izquierda: volver -->
								<a class="btn btn-outline-secondary btn-sm"
									th:href="@{/baseDeConocimiento/upload}"> <i
									class="bi bi-arrow-left"></i> Volver
								</a>
                    <button type="submit" class="btn btn-success mt-3" id="saveAllBtn"
                            th:disabled="${duplicadas != null and !#lists.isEmpty(duplicadas)}">
                        Guardar todas
                    </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const sidebar = document.getElementById("sidebar");

if (!localStorage.getItem("sidebarState")) {
    localStorage.setItem("sidebarState", "collapsed");
}

if (localStorage.getItem("sidebarState") === "collapsed") {
    sidebar.classList.add("collapsed");
} else {
    sidebar.classList.remove("collapsed");
}

function toggleSidebar() {
    sidebar.classList.toggle("collapsed");
    localStorage.setItem(
        "sidebarState",
        sidebar.classList.contains("collapsed") ? "collapsed" : "open"
    );
}

const previewBody = document.getElementById('previewBody');
const totalInput = document.getElementById('totalPreview');
const saveBtn = document.getElementById('saveAllBtn');

/* ---------------- ELIMINAR FILA ---------------- */
previewBody?.addEventListener('click', e => {
    const btn = e.target.closest('.delete-btn');
    if (!btn) return;

    if (confirm('¿Está seguro que desea eliminar esta pregunta?')) {
        btn.closest('.card-preview').remove();
        reindexInputs();
        updateTotal();
        validarTodo();
    }
});

/* ---------------- ESCUCHAR CAMBIOS ---------------- */
previewBody?.addEventListener('input', e => {

    if (e.target.classList.contains('preview-input')) {
        validarTodo();
    }

    /* --------- RESPUESTA EN TIEMPO REAL --------- */
    if (e.target.classList.contains('respuesta-editable')) {
        const card = e.target.closest('.card-preview');
        if (!card) return;

        const value = e.target.value;

        const textareaPreview = card.querySelector('.respuesta-preview');
        const hidden = card.querySelector('.conflicto-hidden-respuesta');

        if (textareaPreview) textareaPreview.value = value;
        if (hidden) hidden.value = value;
    }

    /* --------- PREGUNTA → MOSTRAR / OCULTAR CONFLICTO --------- */
    if (e.target.name?.startsWith('pregunta_')) {
        manejarConflictoPregunta(e.target);
    }
});

/* ---------------- CONFLICTO DINÁMICO ---------------- */
function manejarConflictoPregunta(preguntaInput) {
    const card = preguntaInput.closest('.card-preview');
    if (!card) return;

    const original = (preguntaInput.dataset.original || '').trim();
    const actual = preguntaInput.value.trim();

    const conflictoBlock = card.querySelector('.conflicto-block');
    if (!conflictoBlock) return;

    if (actual === original) {
        conflictoBlock.style.display = '';
    } else {
        conflictoBlock.style.display = 'none';

        // limpiar estado al ocultar
        const checkbox = conflictoBlock.querySelector('input[type="checkbox"]');
        if (checkbox) checkbox.checked = false;
    }
}

/* ---------------- VALIDACIÓN COMPLETA ---------------- */
function validarTodo() {
    const cards = Array.from(previewBody.querySelectorAll('.card-preview'));
    let hayInvalidos = false;

    cards.forEach(card => {
        const preguntaInput = card.querySelector('input[name^="pregunta_"]');
        const respuestaInput = card.querySelector('input[name^="respuesta_"]');

        const pregunta = preguntaInput.value.trim();
        const respuesta = respuestaInput.value.trim();

        const original = (preguntaInput.dataset.original || '').trim();
        const duplicadoInicial = preguntaInput.dataset.duplicadoInicial === "true";

        const todas = cards.map(c =>
            c.querySelector('input[name^="pregunta_"]').value.trim()
        );

        let esDuplicado = false;
        if (pregunta === original) {
            esDuplicado = duplicadoInicial;
        } else {
            esDuplicado = todas.filter(v => v === pregunta).length > 1;
        }
        
        const conflictoBlock = card.querySelector('.conflicto-block');
		if (conflictoBlock) {
		    const checkbox = conflictoBlock.querySelector('input[type="checkbox"]');
		
		    if (pregunta === original) {
		        if (!checkbox || !checkbox.checked) {
		            esDuplicado = true;
		        }
		    }
		}

        const invalidaPregunta = esDuplicado || pregunta.length > 500;
        const invalidaRespuesta = respuesta.length > 1500;

        preguntaInput.classList.toggle("is-invalid", invalidaPregunta);
        respuestaInput.classList.toggle("is-invalid", invalidaRespuesta);

        if (invalidaPregunta || invalidaRespuesta) {
            hayInvalidos = true;
        }
    });

    saveBtn.disabled = hayInvalidos || cards.length === 0;
    actualizarContadores();
}

/* ---------------- CONTADORES ---------------- */
function actualizarContadores() {
    previewBody.querySelectorAll('.card-preview').forEach(card => {
        const pregunta = card.querySelector('input[name^="pregunta_"]');
        const respuesta = card.querySelector('input[name^="respuesta_"]');

        card.querySelector('.pregunta-counter').textContent =
            `${pregunta.value.length} / 500`;
        card.querySelector('.respuesta-counter').textContent =
            `${respuesta.value.length} / 1500`;
    });
}

/* ---------------- REINDEX ---------------- */
function reindexInputs() {
    previewBody.querySelectorAll('.card-preview').forEach((card, i) => {
        card.querySelector('input[name^="pregunta_"]').name = `pregunta_${i}`;
        card.querySelector('input[name^="respuesta_"]').name = `respuesta_${i}`;
    });
    updateTotal();
}

function updateTotal() {
    totalInput.value = previewBody.children.length;
}

previewBody?.addEventListener('change', e => {
    if (e.target.name === 'confirmar_conflicto') {
        validarTodo();
    }
});

/* ---------------- INIT ---------------- */
document.querySelectorAll('input[name^="pregunta_"]').forEach(manejarConflictoPregunta);
validarTodo();

document.querySelectorAll('.card-preview').forEach(card => {
    const respuestaInput = card.querySelector('.respuesta-editable');
    const textareaPreview = card.querySelector('.respuesta-preview');
    const hidden = card.querySelector('.conflicto-hidden-respuesta');

    if (!respuestaInput) return;

    const valorInicial = respuestaInput.value;

    if (textareaPreview && textareaPreview.value === '') {
        textareaPreview.value = valorInicial;
    }

    if (hidden && hidden.value === '') {
        hidden.value = valorInicial;
    }
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
