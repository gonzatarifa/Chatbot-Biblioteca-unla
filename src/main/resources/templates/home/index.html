<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot Unla</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="/css/style-custom.css" rel="stylesheet" />
</head>

<body>
    <div class="wrapper d-flex">
        <div th:replace="fragments/sidebar :: sidebar"></div>

        <div class="content flex-grow-1 p-4 d-flex justify-content-center align-items-start">
            <div id="chatbot-fixed" aria-live="polite" aria-label="Chatbot">

                <!-- Header -->
                <div class="card-header d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <h5 class="mb-0">ðŸ“š Preguntame â€“ Biblioteca PuiggrÃ³s</h5>
                    </div>
                    <a href="/chat/pdf" class="btn btn-outline-danger btn-sm" target="_blank" title="Descargar conversaciÃ³n en PDF">
                        <i class="bi bi-file-earmark-pdf-fill"></i>
                    </a>
                </div>

                <!-- Historial -->
                <div id="chat-messages-scroll" style="flex-grow: 1; overflow-y: auto; margin-bottom: 10px; display: flex; flex-direction: column;">
                    <div th:each="msg : ${historial}">
                        <div th:if="${msg.remitente == 'usuario'}" class="chat-user-msg">
                            <span th:text="${msg.contenido}"></span>
                        </div>
                        <div th:if="${msg.remitente == 'bot'}" class="chat-bot-msg">
                            <span th:text="${msg.contenido}"></span>
                        </div>
                    </div>

                    <!-- Spinner -->
                    <div id="loadingSpinner" class="text-center mb-3" style="display:none;">
                        <div class="spinner-border text-dark" role="status" style="width: 1.5rem; height: 1.5rem;">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-1" style="font-size: .85rem; color: #ccc;">Procesando respuesta...</p>
                    </div>
                </div>

                <!-- Agradecimiento -->
                <div th:if="${agradecimientoFeedback}" class="modern-card mb-3 p-3">
                    <p class="mb-1 text-success" th:text="${agradecimientoFeedback}"></p>
                </div>

                <!-- Formulario Feedback -->
                <div id="formularioFeedback" th:if="${respuestaGenerica}"
                     class="modern-card mt-3 p-3" style="display:block;">
                    <h6 class="card-title mb-2">Formulario</h6>
                    <p class="card-text text-info mb-3">CompletÃ¡ los datos para que un bibliotecario pueda responder tu consulta por correo electrÃ³nico.</p>

                    <form method="post" action="/feedback" class="d-flex flex-column gap-2">
                        <input type="hidden" name="pregunta" th:value="${pregunta}">

                        <div class="row g-2">
                            <div class="col-md-6">
                                <input type="text" name="nombre" class="form-control form-control-sm input-feedback"
                                       placeholder="Nombre" required
                                       th:value="${feedbackSession != null ? feedbackSession.nombre : ''}">
                            </div>

                            <div class="col-md-6">
                                <input type="text" name="apellido" class="form-control form-control-sm input-feedback"
                                       placeholder="Apellido" required
                                       th:value="${feedbackSession != null ? feedbackSession.apellido : ''}">
                            </div>
                        </div>

                        <input type="email" name="email" class="form-control form-control-sm input-feedback mt-2"
                               placeholder="Correo electrÃ³nico" required
                               th:value="${feedbackSession != null ? feedbackSession.email : ''}">

                        <button type="submit" class="btn btn-feedback mt-2 align-self-start">
                            Enviar Formulario
                        </button>
                    </form>
                </div>

                <!-- Formulario Chat -->
                <form id="chatForm" method="post" action="/" style="display:flex; margin-top:10px; align-items:center; gap:5px;">

                    <textarea id="preguntaInput" name="pregunta" placeholder="EscribÃ­ tu pregunta..."
                              required autocomplete="off" rows="1" maxlength="500"
                              style="flex-grow:1; resize:none;"></textarea>

                    <div id="charCount" style="font-size:.75rem; color:#aaa; width:70px; text-align:right;">
                        0 / 500
                    </div>

                    <button id="sendBtn" class="send-btn" type="submit" title="Enviar" disabled>
                        <i id="sendIcon" class="bi bi-arrow-right-short"></i>
                    </button>
                </form>

            </div>
        </div>
    </div>

    <!-- â­ Sidebar Script con estado persistente -->
    <script>
        const sidebar = document.getElementById("sidebar");

        // Estado inicial: forzar cerrado si no existe key
        if (!localStorage.getItem("sidebarState")) {
            localStorage.setItem("sidebarState", "collapsed");
        }

        // Aplicar estado guardado
        if (localStorage.getItem("sidebarState") === "collapsed") {
            sidebar.classList.add("collapsed");
        } else {
            sidebar.classList.remove("collapsed");
        }

        // FunciÃ³n botÃ³n hamburguesa
        function toggleSidebar() {
            sidebar.classList.toggle("collapsed");

            // Guardar estado actualizado
            if (sidebar.classList.contains("collapsed")) {
                localStorage.setItem("sidebarState", "collapsed");
            } else {
                localStorage.setItem("sidebarState", "open");
            }
        }

        const form = document.getElementById("chatForm");
        const textarea = document.getElementById("preguntaInput");
        const sendBtn = document.getElementById("sendBtn");
        const sendIcon = document.getElementById("sendIcon");
        const charCount = document.getElementById("charCount");
        const chatScroll = document.getElementById("chat-messages-scroll");
        const loadingSpinner = document.getElementById("loadingSpinner");

        function scrollToBottom() {
            chatScroll.scrollTop = chatScroll.scrollHeight;
        }
        scrollToBottom();

        textarea.addEventListener("input", function () {
            const len = textarea.value.length;
            charCount.textContent = `${len} / 500`;

            const cleaned = textarea.value.replace(/\s+/g, "");
            sendBtn.disabled = cleaned.length === 0 || len > 500;

            sendIcon.className = cleaned.length === 0 ? "bi bi-arrow-right-short" : "bi bi-arrow-up-short";

            textarea.style.height = 'auto';
            const newHeight = textarea.scrollHeight;
            textarea.style.height = Math.min(newHeight, 150) + 'px';
            textarea.style.overflowY = newHeight > 150 ? 'auto' : 'hidden';
        });

        textarea.addEventListener("keydown", function(e) {
            if (e.key === 'Enter' && sendBtn.disabled) e.preventDefault();
        });

        form.addEventListener("submit", function (e) {
            const cleaned = textarea.value.replace(/\s+/g, "").trim();

            if (!cleaned) {
                e.preventDefault();
                return;
            }

            sendBtn.disabled = true;

            const userMsg = document.createElement("div");
            userMsg.classList.add("chat-user-msg");
            userMsg.innerHTML = `<span>${textarea.value.trim()}</span>`;
            chatScroll.appendChild(userMsg);

            loadingSpinner.style.display = "block";
            scrollToBottom();

            setTimeout(() => form.submit(), 1);
        });

        window.addEventListener("load", scrollToBottom);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
