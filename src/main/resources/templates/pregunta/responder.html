<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot Unla</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="/css/style-custom.css" rel="stylesheet" />
</head>
<body>
<div class="wrapper d-flex">

    <!-- SIDEBAR -->
    <div th:replace="fragments/sidebar :: sidebar" id="sidebar"></div>

    <!-- CONTENIDO -->
    <div class="content p-4 w-100">
        <div class="container">

            <h2 class="mb-4 text-center fw-bold">‚úâÔ∏è Responder Pregunta</h2>

            <!-- PREGUNTA -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title text-primary"
                        id="preguntaOriginal"
                        th:text="${pregunta.pregunta}">
                        Pregunta del usuario
                    </h5>

                    <p class="mb-1">
                        <i class="bi bi-person-fill"></i>
                        <strong>Usuario:</strong>
                        <span th:text="${pregunta.nombre} + ' ' + ${pregunta.apellido}"></span>
                    </p>

                    <p class="mb-1">
                        <i class="bi bi-envelope-at-fill"></i>
                        <strong>Email:</strong>
                        <span th:text="${pregunta.email}"></span>
                    </p>
                </div>
            </div>

            <!-- FORM -->
            <form th:action="@{/preguntas/responder}"
                  method="post"
                  id="respuestaForm"
                  class="needs-validation"
                  novalidate>

                <input type="hidden" name="id" th:value="${pregunta.id}" />

                <input type="hidden" id="usuarioActual" th:value="${#authentication.name}" />
                <input type="hidden" id="hayUsuarioRespondiendo"
                       th:value="${pregunta.usuarioRespondiendo != null}" />
                <input type="hidden" id="nombreUsuarioRespondiendo"
                       th:value="${pregunta.usuarioRespondiendo?.nombreDeUsuario}" />

                <!-- BASE CONOCIMIENTO -->
                <input type="hidden" name="preguntaEditada" id="preguntaEditada" />
                <input type="hidden" name="respuestaEditada" id="respuestaEditada" />
                <input type="hidden" name="guardarEnBaseConocimiento"
                       id="guardarEnBaseConocimiento"
                       value="false" />

                <!-- SALUDO -->
                <div class="mb-3">
                    <label for="saludo" class="form-label">Saludo inicial (opcional)</label>
                    <textarea class="form-control"
                              id="saludo"
                              name="saludo"
                              rows="3"
                              maxlength="200"
                              th:text="${saludoDefault}"
                              placeholder="Ej: Hola, gracias por tu consulta..."></textarea>
                </div>

                <!-- RESPUESTA -->
                <div class="mb-3">
                    <label for="respuesta" class="form-label">
                        Respuesta al usuario (se env√≠a por email)
                    </label>
                    <textarea class="form-control"
                              id="respuesta"
                              name="respuesta"
                              rows="6"
                              maxlength="1500"
                              required></textarea>

                    <div class="invalid-feedback">
                        Este campo es obligatorio
                    </div>

                    <small class="text-warning" id="ayudaRespuestaBK">
						Esta respuesta ser√° enviada tal como la definas aqui. Las modificaciones para la base de conocimiento puedes realizarlas en el siguiente paso.
					</small>
                </div>

                <!-- FIRMA -->
                <div class="mb-3">
                    <label for="firma" class="form-label">Firma (opcional)</label>
                    <textarea class="form-control"
                              id="firma"
                              name="firma"
                              rows="3"
                              maxlength="200"
                              th:text="${firmaDefault}"
                              placeholder="Ej: Atentamente, Soporte UNLA"></textarea>
                </div>

                <!-- CHECK BK -->
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="chkGuardarBK" checked>
                    <label class="form-check-label" for="chkGuardarBK">
                        Guardar esta respuesta en la base de conocimiento
                    </label>
                </div>

                <!-- BOTONES -->
                <div class="d-flex justify-content-between">
                    <a th:href="@{/preguntas/lista}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>

						<button type="submit" class="btn btn-primary" id="btnEnviar">
							<i class="bi bi-arrow-right-circle"></i> <span class="btn-text">Continuar</span>
						</button>
					</div>

            </form>
        </div>
    </div>
</div>

<!-- MODAL BASE CONOCIMIENTO -->
<div class="modal fade" id="modalGuardarBK" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-body">

                <!-- CONTEXTO -->
                <div class="alert alert-info small mb-3">
                    <strong>‚úî El correo al usuario ya est√° definido.</strong><br>
                    Aqu√≠ pod√©s adaptar el contenido para reutilizarlo en la base de
                    conocimiento.
                </div>

                <!-- RESUMEN MAIL (COLAPSABLE) -->
                <p class="mb-2">
						<a class="link-white small" id="togglePreviewMail"
							data-bs-toggle="collapse" href="#previewMail" role="button"
							aria-expanded="false"> üëÅ Ver correo que se enviar√° al
							usuario </a>
					</p>

					<div class="collapse mb-3" id="previewMail">
						<div
							class="border rounded p-2 bg-light small text-dark preview-only">

							<div class="preview-block">
								<span class="preview-title">Pregunta:</span>
								<div class="preview-text" id="previewPregunta"></div>
							</div>

							<div class="preview-separator"></div>

							<div class="preview-block">
								<span class="preview-title">Respuesta:</span>
								<div class="preview-text" id="previewRespuesta"></div>
							</div>

						</div>
					</div>
					<!-- EDICI√ìN BK -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        üìö Pregunta (base de conocimiento)
                    </label>
                    <textarea class="form-control"
                              id="preguntaModal"
                              rows="3"
                              maxlength="500"
                              placeholder="Generaliz√° la pregunta para que sirva a otros usuarios..."></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        üìò Respuesta (base de conocimiento)
                    </label>
                    <textarea class="form-control"
                              id="respuestaModal"
                              rows="4"
                              maxlength="1500"
                              placeholder="Quit√° datos personales y hac√© la respuesta reutilizable..."></textarea>
                </div>

                <p class="text-white small mb-0">
                    Esta informaci√≥n ser√° utilizada por el chatbot para futuras consultas.
                </p>

            </div> <!-- ‚úÖ cierre correcto modal-body -->

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Volver
                </button>

                <button type="button"
                        id="btnConfirmarGuardar"
                        class="btn btn-success">
                    Enviar y guardar respuesta
                </button>
            </div>

        </div>
    </div>
</div>


<script>
const usuarioActual = document.getElementById('usuarioActual')?.value || '';
const hayUsuarioRespondiendo =
    document.getElementById('hayUsuarioRespondiendo')?.value === 'true';
const nombreUsuarioRespondiendo =
    document.getElementById('nombreUsuarioRespondiendo')?.value || '';

const sidebar = document.getElementById("sidebar");

/* ================= SIDEBAR ================= */
if (!localStorage.getItem("sidebarState")) {
    localStorage.setItem("sidebarState", "collapsed");
}

if (localStorage.getItem("sidebarState") === "collapsed") {
    sidebar.classList.add("collapsed");
} else {
    sidebar.classList.remove("collapsed");
}

function toggleSidebar() {
    sidebar.classList.toggle("collapsed");
    localStorage.setItem(
        "sidebarState",
        sidebar.classList.contains("collapsed") ? "collapsed" : "open"
    );
}

/* ================= VALIDACI√ìN BOOTSTRAP ================= */
(function () {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();

/* ================= L√ìGICA PRINCIPAL ================= */
document.addEventListener('DOMContentLoaded', () => {

    const form = document.getElementById('respuestaForm');
    const btnEnviar = document.getElementById('btnEnviar');
    const chkGuardarBK = document.getElementById('chkGuardarBK');
    const hiddenGuardarBK = document.getElementById('guardarEnBaseConocimiento');

    const ayudaRespuestaBK = document.getElementById('ayudaRespuestaBK');

    /* ===== TEXTO DIN√ÅMICO DEL BOT√ìN (UX) ===== */
    function actualizarTextoBoton() {
        const texto = btnEnviar.querySelector('.btn-text');
        texto.innerText = chkGuardarBK.checked
            ? 'Continuar'
            : 'Enviar respuesta al usuario';
    }

    actualizarTextoBoton();

    ayudaRespuestaBK.style.display = chkGuardarBK.checked ? 'block' : 'none';

    chkGuardarBK.addEventListener('change', () => {
        ayudaRespuestaBK.style.display = chkGuardarBK.checked ? 'block' : 'none';
        actualizarTextoBoton();
    });

    const preguntaOriginal =
        document.getElementById('preguntaOriginal').innerText.trim();
    const respuestaInput = document.getElementById('respuesta');

    const modal = new bootstrap.Modal(
        document.getElementById('modalGuardarBK')
    );

    const btnConfirmar = document.getElementById('btnConfirmarGuardar');

    /* ===== CLICK EN BOT√ìN PRINCIPAL ===== */
    btnEnviar.addEventListener('click', function (e) {
        e.preventDefault();

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        /* üî¥ VALIDACI√ìN: OTRO USUARIO RESPONDIENDO */
        if (
            hayUsuarioRespondiendo &&
            nombreUsuarioRespondiendo &&
            nombreUsuarioRespondiendo !== usuarioActual
        ) {
            const confirmacion = confirm(
                `¬øEst√°s seguro? Esta pregunta est√° siendo respondida por ${nombreUsuarioRespondiendo}`
            );

            if (!confirmacion) {
                return;
            }
        }

        /* ===== DECISI√ìN SEG√öN CHECK ===== */
        if (chkGuardarBK.checked) {
            hiddenGuardarBK.value = 'true';

            document.getElementById('preguntaModal').value = preguntaOriginal;
            document.getElementById('respuestaModal').value = respuestaInput.value;
			
            const previewPregunta = document.getElementById('previewPregunta');
            const previewRespuesta = document.getElementById('previewRespuesta');

            if (previewPregunta) {
                previewPregunta.innerText = preguntaOriginal;
            }
            if (previewRespuesta) {
                previewRespuesta.innerText = respuestaInput.value;
            }
            modal.show();
        } else {
            hiddenGuardarBK.value = 'false';
            bloquearEnvio();
            form.submit();
        }
    });

    /* ===== CONFIRMAR DESDE MODAL ===== */
    btnConfirmar.addEventListener('click', function () {
    	document.getElementById('respuestaUsuarioPreview').value = respuestaInput.value;
    	document.getElementById('respuestaModal').value = respuestaInput.value;
    	
        document.getElementById('preguntaEditada').value =
            document.getElementById('preguntaModal').value;

        document.getElementById('respuestaEditada').value =
            document.getElementById('respuestaModal').value;

        bloquearEnvio();
        modal.hide();
        form.submit();
    });

    /* ===== BLOQUEO DE DOBLE ENV√çO ===== */
    function bloquearEnvio() {
        btnEnviar.disabled = true;
        btnEnviar.querySelector('.btn-text').innerText = 'Enviando...';
    }
});

document.addEventListener('DOMContentLoaded', function () {

    const previewCollapse = document.getElementById('previewMail');
    const togglePreviewLink = document.getElementById('togglePreviewMail');

    if (!previewCollapse || !togglePreviewLink) return;

    previewCollapse.addEventListener('show.bs.collapse', function () {
        togglePreviewLink.innerHTML =
            '<i class="bi bi-eye-slash me-1"></i> Ocultar correo que se enviara al usuario';
    });

    previewCollapse.addEventListener('hide.bs.collapse', function () {
        togglePreviewLink.innerHTML =
            '<i class="bi bi-eye me-1"></i> Ver correo que se enviara al usuario';
    });

});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
