<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot Unla</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="/css/style-custom.css" rel="stylesheet" />
</head>
<body>
<div class="wrapper d-flex">

    <!-- Sidebar -->
    <div th:replace="fragments/sidebar :: sidebar" id="sidebar"></div>

    <!-- Contenido -->
    <div class="content p-4 w-100">
        <div class="container">

            <h2 class="mb-4 text-center fw-bold">九괦잺 Responder Pregunta</h2>

            <!-- DATOS DE LA PREGUNTA -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title text-primary"
                        id="preguntaOriginal"
                        th:text="${pregunta.pregunta}">
                        Pregunta del usuario
                    </h5>

                    <p class="mb-1">
                        <i class="bi bi-person-fill"></i>
                        <strong>Usuario:</strong>
                        <span th:text="${pregunta.nombre} + ' ' + ${pregunta.apellido}"></span>
                    </p>

                    <p class="mb-1">
                        <i class="bi bi-envelope-at-fill"></i>
                        <strong>Email:</strong>
                        <span th:text="${pregunta.email}"></span>
                    </p>
                </div>
            </div>

            <!-- FORM -->
            <form th:action="@{/preguntas/responder}"
                  method="post"
                  id="respuestaForm"
                  class="needs-validation"
                  novalidate>

                <!-- IDs -->
                <input type="hidden" name="id" th:value="${pregunta.id}" />

                <!-- Control concurrencia -->
                <input type="hidden" id="usuarioActual" th:value="${#authentication.name}" />
                <input type="hidden" id="hayUsuarioRespondiendo"
                       th:value="${pregunta.usuarioRespondiendo != null}" />
                <input type="hidden" id="nombreUsuarioRespondiendo"
                       th:value="${pregunta.usuarioRespondiendo?.nombreDeUsuario}" />

                <!-- Campos base conocimiento -->
                <input type="hidden" name="preguntaEditada" id="preguntaEditada" />
                <input type="hidden" name="respuestaEditada" id="respuestaEditada" />
                <input type="hidden"
                       name="guardarEnBaseConocimiento"
                       id="guardarEnBaseConocimiento"
                       value="false" />

                <!-- SALUDO -->
					<div class="mb-3">
						<label for="saludo" class="form-label">Saludo inicial
							(opcional)</label>
						<textarea class="form-control" id="saludo" name="saludo"
							placeholder="Ej: Hola, gracias por tu consulta..." rows="3"
							th:text="${saludoDefault}"  maxlength="200">
   						 </textarea>
					</div>

					<!-- RESPUESTA -->
                <div class="mb-3">
                    <label for="respuesta" class="form-label">
                        Respuesta al usuario (se env칤a por email)
                    </label>
                    <textarea class="form-control"
                              id="respuesta"
                              name="respuesta"
                              rows="6"
                              required  maxlength="1500"></textarea>
                    <div class="invalid-feedback">
                        Este campo es obligatorio
                    </div>
                    <small class="text-secondary" id="ayudaRespuestaBK">
						Esta respuesta ser치 enviada tal como est치 al usuario. Las modificaciones para la base de conocimiento se realizan en el siguiente paso.
					</small>
                </div>

					<div class="mb-3">
						<label for="firma" class="form-label">Firma (opcional)</label>
						<textarea class="form-control" id="firma" name="firma"
							placeholder="Ej: Atentamente, Soporte UNLA" rows="3"
							th:text="${firmaDefault}"  maxlength="200">
    					</textarea>
					</div>

					<!-- CHECK BASE CONOCIMIENTO -->
					<div class="form-check mb-4">
						<input class="form-check-input" type="checkbox" id="chkGuardarBK"
							checked> <label class="form-check-label"
							for="chkGuardarBK"> Guardar respuesta en
							la base de conocimiento </label>
					</div>

					<!-- ACCIONES -->
                <div class="d-flex justify-content-between">
                    <a th:href="@{/preguntas/lista}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>

                    <button type="submit" class="btn btn-primary" id="btnEnviar">
                        <i class="bi bi-send"></i>
                        <span class="btn-text">Enviar Respuesta</span>
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- MODAL BASE CONOCIMIENTO -->
<div class="modal fade"
     id="modalGuardarBK"
     tabindex="-1"
     aria-hidden="true">

    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">
                    Adaptar contenido para la base de conocimiento
                </h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
            
            <div class="alert alert-info mb-4" role="alert">
			    <strong>Importante:</strong><br>
			    Los cambios que hagas aqu칤 <strong>NO afectan</strong> el mail enviado al usuario.<br>
			    Esta informaci칩n ser치 usada 칰nicamente para la <strong>base de conocimiento</strong>.
			</div>

                <div class="mb-3">
                    <label class="form-label">Pregunta (versi칩n para la base de conocimiento)</label>
                    <textarea class="form-control input-claro"
                              id="preguntaModal"
                              rows="3"
                              maxlength="500"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Respuesta (versi칩n para la base de conocimiento)</label>
                    <textarea class="form-control input-claro"
                              id="respuestaModal"
                              rows="4"
                              maxlength="1500"></textarea>
                </div>

                <p class="text-white small mb-0">
                    Esta informaci칩n ser치 utilizada por el chatbot para futuras consultas.
                </p>

            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancelar
                </button>

                <button type="button"
                        id="btnConfirmarGuardar"
                        class="btn btn-success">
                    Enviar y guardar
                </button>
            </div>

        </div>
    </div>
</div>

<script>
const usuarioActual = document.getElementById('usuarioActual')?.value || '';
const hayUsuarioRespondiendo =
    document.getElementById('hayUsuarioRespondiendo')?.value === 'true';
const nombreUsuarioRespondiendo =
    document.getElementById('nombreUsuarioRespondiendo')?.value || '';

const sidebar = document.getElementById("sidebar");

/* ================= SIDEBAR ================= */
if (!localStorage.getItem("sidebarState")) {
    localStorage.setItem("sidebarState", "collapsed");
}

if (localStorage.getItem("sidebarState") === "collapsed") {
    sidebar.classList.add("collapsed");
} else {
    sidebar.classList.remove("collapsed");
}

function toggleSidebar() {
    sidebar.classList.toggle("collapsed");
    localStorage.setItem(
        "sidebarState",
        sidebar.classList.contains("collapsed") ? "collapsed" : "open"
    );
}

(function () {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();

/* ================= L칍GICA PRINCIPAL ================= */
document.addEventListener('DOMContentLoaded', () => {

    const form = document.getElementById('respuestaForm');
    const btnEnviar = document.getElementById('btnEnviar');
    const chkGuardarBK = document.getElementById('chkGuardarBK');
    const hiddenGuardarBK = document.getElementById('guardarEnBaseConocimiento');
    
    const ayudaRespuestaBK = document.getElementById('ayudaRespuestaBK');

	ayudaRespuestaBK.style.display = chkGuardarBK.checked ? 'block' : 'none';
	
	chkGuardarBK.addEventListener('change', () => {
	    ayudaRespuestaBK.style.display = chkGuardarBK.checked ? 'block' : 'none';
	});

    const preguntaOriginal =
        document.getElementById('preguntaOriginal').innerText.trim();
    const respuestaInput = document.getElementById('respuesta');

    const modal = new bootstrap.Modal(
        document.getElementById('modalGuardarBK')
    );

    const btnConfirmar = document.getElementById('btnConfirmarGuardar');

    /* ===== CLICK EN ENVIAR ===== */
    btnEnviar.addEventListener('click', function (e) {
        e.preventDefault();

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }

        /* 游댮 VALIDACI칍N: OTRO USUARIO RESPONDIENDO */
        if (
            hayUsuarioRespondiendo &&
            nombreUsuarioRespondiendo &&
            nombreUsuarioRespondiendo !== usuarioActual
        ) {
            const confirmacion = confirm(
                `쮼st치s seguro? Esta pregunta est치 siendo respondida por ${nombreUsuarioRespondiendo}`
            );

            if (!confirmacion) {
                return;
            }
        }

        /* ===== DECISI칍N SEG칔N CHECK ===== */
        if (chkGuardarBK.checked) {
            hiddenGuardarBK.value = 'true';

            document.getElementById('preguntaModal').value = preguntaOriginal;
            document.getElementById('respuestaModal').value = respuestaInput.value;

            modal.show();
        } else {
            hiddenGuardarBK.value = 'false';
            bloquearEnvio();
            form.submit();
        }
    });

    /* ===== CONFIRMAR DESDE MODAL ===== */
    btnConfirmar.addEventListener('click', function () {

        document.getElementById('preguntaEditada').value =
            document.getElementById('preguntaModal').value;

        document.getElementById('respuestaEditada').value =
            document.getElementById('respuestaModal').value;

        bloquearEnvio();
        modal.hide();
        form.submit();
    });

    /* ===== BLOQUEO DE DOBLE ENV칈O ===== */
    function bloquearEnvio() {
        btnEnviar.disabled = true;
        btnEnviar.querySelector('.btn-text').innerText = 'Enviando...';
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
